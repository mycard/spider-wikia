// Generated by CoffeeScript 1.6.3
(function() {
  var ajax, info, list, listInfo, message, spiderContent, spiderList, state, stateName;

  info = list = null;

  state = 0;

  stateName = ['初始化', '列表采集完成', '内容采集完成', '操作中'];

  listInfo = {
    page: 0,
    url: ''
  };

  spiderList = function() {
    var showList, spiderOneList;
    if (state > 0) {
      return alert(stateName[state]);
    }
    message('开始采集列表页...');
    state = 3;
    spiderOneList = function(page, url) {
      if (!(page && url)) {
        url = '';
      }
      state = 0;
      if (typeof url !== 'string') {
        throw 'url miss';
      }
      listInfo = {
        page: page,
        url: url
      };
      message("正在采集第" + page + "页");
      return ajax(baseUrl + 'app.php?action=spiderlist&url=' + encodeURIComponent(url), void 0, function(res) {
        var item, _i, _len, _ref;
        if (!res.state) {
          return message("失败" + res.error);
        }
        message("成功");
        _ref = res.data;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          showList(item.name, item.url);
        }
        if (res.next) {
          return spiderOneList(++page, res.next);
        } else {
          message('列表页采集完毕');
          return state = 1;
        }
      }, function(res) {
        return alert("失败(" + res.url + ")");
      });
    };
    showList = function(name, url) {
      var tr;
      tr = document.createElement('tr');
      tr.innerHTML = "<td>" + name + "</td><td><a href=\"" + url + "\" target=\"_blank\">link</a></td><td></td>";
      return list.appendChild(tr);
    };
    return spiderOneList(listInfo.page, listInfo.url);
  };

  spiderContent = function() {
    var index, length, spiderOneContent, trs;
    index = length = 0;
    if (state > 1) {
      return alert(stateName[state]);
    }
    message('开始采集内容页...');
    state = 3;
    spiderOneContent = function(tr) {
      var name;
      name = tr.firstChild.innerHTML;
      return ajax(baseUrl + 'app.php?action=spidercontent&name=' + name, void 0, function(res) {
        if (res.state) {
          tr.querySelectorAll('td')[2].innerHTML = '成功';
        } else {
          tr.querySelectorAll('td')[2].innerHTML = '失败';
        }
        if (index < length) {
          return spiderOneContent(trs.item(index++));
        } else {
          message('采集结束');
          return state = 2;
        }
      }, function(res) {
        tr.querySelectorAll('td')[2].innerHTML = '失败';
        if (index < length) {
          return spiderOneContent(trs.item(index++));
        } else {
          message('采集结束');
          return state = 2;
        }
      });
    };
    trs = document.getElementById('list').querySelectorAll('tr');
    if (!trs.length) {
      return alert('列表为空');
    }
    length = trs.length;
    index = 0;
    return spiderOneContent(trs.item(index++));
  };

  message = function(text) {
    if (info.value.length > 0) {
      info.value += "\r\n";
    }
    return info.value += text;
  };

  ajax = function(url, data, success, error) {
    var method, xhr;
    console.log(url);
    method = typeof data === 'string' && data.length > 0 ? 'post' : 'get';
    xhr = new XMLHttpRequest();
    xhr.open(method, url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          return success(JSON.parse(xhr.responseText));
        } else {
          return error(JSON.parse(xhr.responseText));
        }
      }
    };
    return xhr.send(data);
  };

  window.onload = function() {
    info = document.querySelector('#info');
    list = document.querySelector('#list');
    message('前端脚本加载完毕');
    document.querySelector('#spiderList').addEventListener('click', function() {
      return spiderList();
    });
    return document.querySelector('#spiderContent').addEventListener('click', function() {
      return spiderContent();
    });
  };

}).call(this);
